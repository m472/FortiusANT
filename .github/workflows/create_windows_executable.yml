name: MakeExe

on: [push]

jobs:
    build:
        runs-on: windows-latest
        steps:
          - uses: actions/checkout@v2

          - uses: actions/setup-python@v2
            with:
              python-version: 3.8

          - uses: actions/cache@v2
            id: cache
            with:
              path: ~\AppData\Local\pip\Cache
              key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
              restore-keys: |
                ${{ runner.os }}-pip-

          - name: Install packages
            if: steps.cache.outputs.cache-hit != 'true'
            run: |
              pip install -r "pythoncode/requirements.txt"
              pip install pyinstaller pypiwin32

          - uses: actions/cache@v2
            id: cache_libusb
            with:
              path: C:\Windows\System32\libusb0.dll
              key: libusb
              restore-keys: |
                libusb

          - name: Download, unzip and move libusb0.dll to C:\Windows\System32
            if: steps.cache_libusb.outputs.cache-hit != 'true'
            run: |
              choco install wget unzip
              wget https://vorboss.dl.sourceforge.net/project/libusb-win32/libusb-win32-releases/1.2.6.0/libusb-win32-bin-1.2.6.0.zip
              unzip libusb-win32-bin-1.2.6.0.zip
              move libusb-win32-bin-1.2.6.0\bin\amd64\libusb0.dll C:\Windows\System32\libusb0.dll
            shell: cmd

          - name: Create basic spec file for FortiusANT
            run: |
              cd Development
              call "FortiusANT Create basic spec file.bat"
            shell: cmd

          - name: Build FortiusANT
            run: |
              cd Development
              call "FortiusANT CreateWindowsExecutable.bat"
            shell: cmd

          - uses: actions/upload-artifact@v2
            with:
              name: my-artifact
              path: pythoncode\dist\FortiusANT.exe

